```{r data generation, results='hide', echo=FALSE}
pacman::p_load(tidyverse, exams)
## DATA GENERATION
n <- 10 + sample(1:5, 3)
dat <- data.frame(Energy = rnorm(sum(n),
    mean = rep(sample(seq(from = sample(50:70, 1), by = 1, length.out = sample(10:15, 1)), 3)/10, n),
    sd = rep(sample(60:80, 3)/100, n)),
  Diet = factor(rep(1:3, n),
    labels = c("Vegetarian", "Omnivore", "Vegan")))
dat$Energy[dat$Energy > 10] <- 10
dat$Energy[dat$Energy <  0] <-  0

## QUESTION/ANSWER GENERATION
questions <- character(5)
solutions <- logical(5)
explanations <- character(5)

fm0 <- lm(Energy ~ 1, data = dat)
fm1 <- lm(Energy ~ Diet, data = dat)
myanova <- anova(fm0, fm1)

## Build a nicely formatted ANOVA comparison table
myanova_print <- as.data.frame(myanova)

# Round and format columns
myanova_print$Res.Df   <- round(myanova$Res.Df, 0)
myanova_print$RSS      <- format(round(myanova$RSS, 3), nsmall = 3)
myanova_print$Df       <- ifelse(is.na(myanova$Df), "", myanova$Df)
myanova_print$`Sum of Sq` <- ifelse(is.na(myanova$"Sum of Sq"), "", 
                                    format(round(myanova$"Sum of Sq", 3), nsmall = 3))
myanova_print$F        <- ifelse(is.na(myanova$F), "", 
                                 format(round(myanova$F, 3), nsmall = 3))
myanova_print$`Pr(>F)` <- ifelse(is.na(myanova$"Pr(>F)"), "", 
                                 format.pval(myanova$"Pr(>F)", digits = 4))
# Reorder and print nicely
myanova_print <- myanova_print[, c("Res.Df", "RSS", "Df", "Sum of Sq", "F", "Pr(>F)")]

rss <- round(myanova[,2], digits = max(0, min(3, 5-max(nchar(round(myanova[, 2], digits = 0))))))
r2 <- 1 - as.numeric(rss[2])/as.numeric(rss[1])

# print(myanova_print, row.names = FALSE, quote = FALSE, right = TRUE)


## Randomized question generation
f2 <- sample(10:250, 1)/10
if(runif(1) > 0.5) {
  questions[1] <- paste0("The test statistic is smaller than $", f2, "$.")
  solutions[1] <- myanova[2,5] < f2
  explanations[1] <- paste0("The test statistic is $F = ", round(myanova[2,5], 3),
    "$ and hence ", ifelse(solutions[1], "", "_not_"), " smaller than $", f2, "$.")
} else {
  questions[1] <- paste0("The test statistic is larger than $", f2, "$.")
  solutions[1] <- myanova[2,5] > f2
  explanations[1] <- paste0("The test statistic is $F = ", round(myanova[2,5], 3),
    "$ and hence ", ifelse(solutions[1], "", "_not_"), " larger than $", f2, "$.")
}

questions[2] <- "A one-sided alternative was tested for the mean energy levels."
solutions[2] <- FALSE
explanations[2] <- "ANOVA tests the null hypothesis that all mean values are equal against the alternative that at least one differs."

r2a <- sample(10:60, 1)/100
questions[3] <- paste0("The fraction of explained variance is larger than $", 100 * r2a, "$%.")
solutions[3] <- r2 > r2a
explanations[3] <- paste0("The fraction of explained variance is $", round(r2, 3), "$ and hence ", 
                          ifelse(solutions[3], "", "_not_"), " larger than ", r2a, ".")

questions[4] <- paste("It can be shown that the reported energy levels depend on the type of diet.",
                      "(Significance level $5$%)")
solutions[4] <- myanova[2,6] < 0.05
explanations[4] <- paste0("The $p$ value is $", format.pval(myanova[2,6], digits = 3),
  "$ and hence", ifelse(solutions[4], "", "_not_"),
  " significant. It can ", ifelse(solutions[4], "", "_not_"),
  " be shown that diet type affects reported energy levels.")

r2b <- if(any(solutions)) sample(10:60, 1)/100 else min(sample(ceiling(100 * r2) + 1:10, 1), 100)/100
questions[5] <- paste0("The fraction of explained variance is smaller than $", 100 * r2b, "$%.")
solutions[5] <- r2 < r2b
explanations[5] <- paste0("The fraction of explained variance is $", round(r2, 3),
  "$ and hence ", ifelse(solutions[5], "", "_not_"), " smaller than ", r2b, ".")

## Randomize order
o <- sample(1:5)
questions <- questions[o]
solutions <- solutions[o]
explanations <- explanations[o]

```


Question
===============

A study with `r sum(n)` participants was conducted to evaluate the impact of different diet types on self-reported daily energy levels.
Participants rated their energy on an eleven-point scale from 0 (very low) to 10 (very high).
The evaluations are summarised by diet type in the following figure:

```{r boxplots, echo = FALSE, results = "hide", fig.height = 3.5, fig.width = 5.8, fig.path = "", fig.cap = ""}
par(mar = c(4, 4, 1, 1))
plot(Energy ~ Diet, data = dat)
```

To analyse whether the reported energy levels differ by diet, an ANOVA was performed:

```{r anova output, echo = FALSE, comment = NA}
options(show.signif.stars = FALSE)
print(myanova_print, quote = FALSE, right = TRUE)

```

Which of the following statements are correct?

```{r questionlist, echo = FALSE, results = "asis"}
answerlist(questions, markup = "markdown")
```



Solution
============
To evaluate the statements, the fraction of explained variance is computed as

$$1 - \mathit{RSS}_1/\mathit{RSS}_0 = 1 - `r rss[2]`/`r rss[1]` =
`r round(r2, digits = 3)`$$

Meta-information
================
extype: mchoice
exsolution: `r mchoice2string(solutions)`
exname: Analysis of variance â€“ Diet and Energy

